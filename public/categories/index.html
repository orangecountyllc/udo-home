<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birdy - Categories</title>
      <link rel="icon" href="../static/logo/birdy-1024.png" type="image/png" />
    <script src="../assets/js/config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            border-radius: 12px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }

        .section h2 {
            color: #ff6b35;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #ff6b35;
            padding-bottom: 10px;
        }

        .button {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 107, 53, 0.3);
        }

        .button.secondary {
            background: #6c757d;
        }

        .button.danger {
            background: #dc3545;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .category-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .category-card:hover {
            border-color: #ff6b35;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .category-card h3 {
            color: #ff6b35;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .category-card .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .category-card .description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .category-card .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .hidden {
            display: none;
        }

        /* Toggle Switch Styles */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .toggle-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .toggle-switch.active {
            background: #ff6b35;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active::after {
            transform: translateX(30px);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.active {
            background: #e6ffe6;
            color: #51cf66;
            border: 1px solid #51cf66;
        }

        .status-badge.inactive {
            background: #ffe6e6;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }

        .category-card.inactive {
            opacity: 0.7;
            border-color: #ccc;
            background: #f0f0f0;
        }

        .category-card.inactive:hover {
            border-color: #ccc;
        }

        /* Toggle button in actions */
        .toggle-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .toggle-button:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .toggle-button.enable {
            background: #28a745;
        }

        .toggle-button.enable:hover {
            background: #218838;
        }

        .toggle-button.disable {
            background: #ffc107;
            color: #000;
        }

        .toggle-button.disable:hover {
            background: #e0a800;
        }

        .api-section {
            background: #f8f9fa;
            border-left: 4px solid #ff6b35;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .api-section h3 {
            color: #ff6b35;
            margin-bottom: 15px;
        }

        .api-endpoint {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }

        .method {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            margin-right: 10px;
        }

        .method.get { background: #28a745; color: white; }
        .method.post { background: #007bff; color: white; }
        .method.put { background: #ffc107; color: black; }
        .method.delete { background: #dc3545; color: white; }
        .method.patch { background: #6f42c1; color: white; }

        .response {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .error {
            color: #ff6b6b;
            background: #ffe6e6;
            border: 1px solid #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success {
            color: #51cf66;
            background: #e6ffe6;
            border: 1px solid #51cf66;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #ff6b35;
            border-bottom-color: #ff6b35;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #ff6b35;
            margin: 0;
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f8f9fa;
            color: #333;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .button-group .button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üê¶ Birdy</h1>
            <p>Service Categories</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('view-categories')">View Categories</button>
            <button class="tab" onclick="showTab('api-test')">API Testing</button>
        </div>

        <!-- View Categories Tab -->
        <div id="view-categories" class="tab-content active">
            <div class="section">
                <h2>Current Categories</h2>
                <button class="button" onclick="loadCategories()">üîÑ Refresh Categories</button>
                <button class="button" onclick="openAddCategoryModal()">‚ûï Add New Category</button>
                <div id="categories-list" class="categories-grid">
                    <div class="loading">Loading categories...</div>
                </div>
            </div>
        </div>

        <!-- Add Category Tab -->
        <div id="add-category" class="tab-content">
            <div class="section">
                <h2>Add New Category</h2>
                <form id="category-form">
                    <div class="form-group">
                        <label for="category-id">Category ID:</label>
                        <input type="text" id="category-id" required placeholder="e.g., hvac">
                    </div>
                    <div class="form-group">
                        <label for="category-name">Category Name:</label>
                        <input type="text" id="category-name" required placeholder="e.g., HVAC Services">
                    </div>
                    <div class="form-group">
                        <label for="category-icon">Icon Name:</label>
                        <input type="text" id="category-icon" required placeholder="e.g., fan">
                    </div>
                    <div class="form-group">
                        <label for="category-description">Description:</label>
                        <textarea id="category-description" required placeholder="Describe the category..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="category-group">Group:</label>
                        <select id="category-group">
                            <option value="home">Home Services</option>
                            <option value="automotive">Automotive</option>
                            <option value="personal">Personal Services</option>
                            <option value="professional">Professional</option>
                            <option value="transportation">Transportation</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="category-rate-type">Rate Type:</label>
                        <select id="category-rate-type">
                            <option value="hourly">Hourly</option>
                            <option value="flat">Flat Rate</option>
                            <option value="quote">Quote Based</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="category-base-rate">Base Rate ($):</label>
                        <input type="number" id="category-base-rate" step="0.01" placeholder="75.00">
                    </div>
                    <button type="submit" class="button">‚ûï Add Category</button>
                </form>
            </div>
        </div>

        <!-- API Testing Tab -->
        <div id="api-test" class="tab-content">
            <div class="section">
                <h2>API Testing</h2>
                <div class="api-section">
                    <h3>Available Endpoints</h3>
                    <div class="api-endpoint">
                        <span class="method get">GET</span>/categories - Get all categories
                        <button class="button" onclick="testGetCategories()">Test</button>
                    </div>
                    <div class="api-endpoint">
                        <span class="method get">GET</span>/categories/{id} - Get specific category
                        <input type="text" id="get-category-id" placeholder="Category ID" style="width: 200px; margin: 0 10px;">
                        <button class="button" onclick="testGetCategory()">Test</button>
                    </div>
                    <div class="api-endpoint">
                        <span class="method post">POST</span>/admin/categories - Create category
                        <button class="button" onclick="testCreateCategory()">Test</button>
                    </div>
                    <div class="api-endpoint">
                        <span class="method put">PUT</span>/admin/categories/{id} - Update category
                        <input type="text" id="update-category-id" placeholder="Category ID" style="width: 200px; margin: 0 10px;">
                        <button class="button" onclick="testUpdateCategory()">Test</button>
                    </div>
                    <div class="api-endpoint">
                        <span class="method delete">DELETE</span>/admin/categories/{id} - Delete category
                        <input type="text" id="delete-category-id" placeholder="Category ID" style="width: 200px; margin: 0 10px;">
                        <button class="button danger" onclick="testDeleteCategory()">Test</button>
                    </div>
                    <div class="api-endpoint">
                        <span class="method patch">PATCH</span>/admin/categories/{id}/toggle - Toggle category status
                        <input type="text" id="toggle-category-id" placeholder="Category ID" style="width: 150px; margin: 0 10px;">
                        <select id="toggle-status" style="margin: 0 10px;">
                            <option value="true">Enable</option>
                            <option value="false">Disable</option>
                        </select>
                        <button class="button" onclick="testToggleCategory()">Test</button>
                    </div>
                </div>
                <div id="api-response"></div>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Category</h2>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-category-form">
                <input type="hidden" id="edit-category-original-id">
                
                <div class="form-group">
                    <label for="edit-category-id">Category ID:</label>
                    <input type="text" id="edit-category-id" required placeholder="e.g., hvac">
                </div>
                
                <div class="form-group">
                    <label for="edit-category-name">Category Name:</label>
                    <input type="text" id="edit-category-name" required placeholder="e.g., HVAC Services">
                </div>
                
                <div class="form-group">
                    <label for="edit-category-icon">Icon Name:</label>
                    <input type="text" id="edit-category-icon" required placeholder="e.g., fan">
                </div>
                
                <div class="form-group">
                    <label for="edit-category-description">Description:</label>
                    <textarea id="edit-category-description" required placeholder="Describe the category..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="edit-category-group">Group:</label>
                    <select id="edit-category-group">
                        <option value="home">Home Services</option>
                        <option value="automotive">Automotive</option>
                        <option value="personal">Personal Services</option>
                        <option value="professional">Professional</option>
                        <option value="transportation">Transportation</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-category-rate-type">Rate Type:</label>
                    <select id="edit-category-rate-type">
                        <option value="hourly">Hourly</option>
                        <option value="flat">Flat Rate</option>
                        <option value="quote">Quote Based</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-category-base-rate">Base Rate ($):</label>
                    <input type="number" id="edit-category-base-rate" step="0.01" placeholder="75.00">
                </div>
                
                <div class="toggle-container">
                    <label class="toggle-label">Category Status:</label>
                    <label class="toggle-switch" id="edit-category-toggle">
                        <input type="checkbox" id="edit-category-is-active">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="status-badge" id="edit-status-badge">Inactive</span>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="button secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="button">üíæ Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Tab switching
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'view-categories') {
                loadCategories();
            }
        }

        // Load and display categories
        async function loadCategories() {
            const container = document.getElementById('categories-list');
            container.innerHTML = '<div class="loading">Loading categories...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/categories`);
                
                // Check if response is OK before trying to parse JSON
                if (!response.ok) {
                    // Try to get error text for authentication errors
                    const errorText = await response.text();
                    
                    if (response.status === 401) {
                        container.innerHTML = `<div class="error">Authentication required: ${errorText || 'Unauthorized access'}</div>`;
                    } else {
                        container.innerHTML = `<div class="error">HTTP ${response.status}: ${errorText || 'Request failed'}</div>`;
                    }
                    return;
                }
                
                // Only parse JSON if response is OK
                const data = await response.json();
                
                if (data.success) {
                    displayCategories(data.categories);
                } else {
                    container.innerHTML = `<div class="error">Error: ${data.message || 'Failed to load categories'}</div>`;
                }
            } catch (error) {
                if (error instanceof SyntaxError && error.message.includes('JSON')) {
                    container.innerHTML = `<div class="error">Invalid response from server. The API may require authentication or be misconfigured.</div>`;
                } else {
                    container.innerHTML = `<div class="error">Network error: ${error.message}</div>`;
                }
            }
        }

        function displayCategories(categories) {
            const container = document.getElementById('categories-list');
            
            if (categories.length === 0) {
                container.innerHTML = '<div class="loading">No categories found</div>';
                return;
            }
            
            container.innerHTML = categories.map(category => {
                const isActive = category.is_active !== false; // Default to true if not set
                const statusClass = isActive ? 'active' : 'inactive';
                const statusText = isActive ? 'Active' : 'Inactive';
                const toggleText = isActive ? 'Disable' : 'Enable';
                const toggleClass = isActive ? 'disable' : 'enable';
                const cardClass = isActive ? '' : 'inactive';
                
                return `
                    <div class="category-card ${cardClass}">
                        <div class="icon">${category.icon || 'üì¶'}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0;">${category.name}</h3>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="description">${category.description || 'No description available'}</div>
                        <p><strong>ID:</strong> ${category.id}</p>
                        <p><strong>Group:</strong> ${category.group || 'N/A'}</p>
                        <p><strong>Rate:</strong> ${category.rate_type || 'N/A'} - $${category.base_rate || '0'}</p>
                        <div class="actions">
                            <button class="button" onclick="editCategory('${category.id}')">‚úèÔ∏è Edit</button>
                            <button class="button danger" onclick="deleteCategory('${category.id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Form submission
        document.getElementById('category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const categoryData = {
                id: document.getElementById('category-id').value,
                name: document.getElementById('category-name').value,
                icon: document.getElementById('category-icon').value,
                description: document.getElementById('category-description').value,
                group: document.getElementById('category-group').value,
                rate_type: document.getElementById('category-rate-type').value,
                base_rate: parseFloat(document.getElementById('category-base-rate').value) || 0,
                keywords: [],
                skills: [],
                documentation: [],
                options: {},
                pricing: {},
                sub_categories: [],
                time_modifiers: [],
                filters: [],
                subscription_pricing: {
                    monthly_pass: { enabled: false, price_cents: 0, price_display: "", description: "", stripe_price_id: "" },
                    flexible: { enabled: false, price_cents: 0, price_display: "", description: "", stripe_price_id: "" }
                },
                is_menu_based: false,
                menu_fields: {}
            };
            
            try {
                const response = await fetch(`${API_BASE}/admin/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(categoryData)
                });
                
                let apiResult;
                try {
                    apiResult = await response.json();
                } catch (jsonError) {
                    const errorText = await response.text();
                    alert(`Error: ${errorText || 'Invalid response from server'}`);
                    return;
                }
                
                if (apiResult.success) {
                    closeEditModal();
                    loadCategories(); // Refresh categories list
                    alert(successMessage);
                } else {
                    alert('Error: ' + (apiResult.message || 'Failed to save category'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        });

        // API Testing functions
        async function testGetCategories() {
            await makeAPIRequest('GET', '/categories', null, 'Get All Categories');
        }

        async function testGetCategory() {
            const categoryId = document.getElementById('get-category-id').value;
            if (!categoryId) {
                alert('Please enter a category ID');
                return;
            }
            await makeAPIRequest('GET', `/categories/${categoryId}`, null, 'Get Category');
        }

        async function testCreateCategory() {
            const testData = {
                id: "test-category",
                name: "Test Category",
                icon: "test",
                description: "A test category created via API",
                group: "test",
                rate_type: "hourly",
                base_rate: 50,
                keywords: [],
                skills: [],
                documentation: [],
                options: {},
                pricing: {},
                sub_categories: [],
                time_modifiers: [],
                filters: [],
                subscription_pricing: {
                    monthly_pass: { enabled: false, price_cents: 0, price_display: "", description: "", stripe_price_id: "" },
                    flexible: { enabled: false, price_cents: 0, price_display: "", description: "", stripe_price_id: "" }
                },
                is_menu_based: false,
                menu_fields: {}
            };
            await makeAPIRequest('POST', '/admin/categories', testData, 'Create Category');
        }

        async function testUpdateCategory() {
            const categoryId = document.getElementById('update-category-id').value;
            if (!categoryId) {
                alert('Please enter a category ID');
                return;
            }
            
            const testData = {
                name: "Updated Test Category",
                description: "Updated description via API",
                base_rate: 75
            };
            await makeAPIRequest('PUT', `/admin/categories/${categoryId}`, testData, 'Update Category');
        }

        async function testDeleteCategory() {
            const categoryId = document.getElementById('delete-category-id').value;
            if (!categoryId) {
                alert('Please enter a category ID');
                return;
            }
            if (!confirm(`Are you sure you want to delete category "${categoryId}"?`)) {
                return;
            }
            await makeAPIRequest('DELETE', `/admin/categories/${categoryId}`, null, 'Delete Category');
        }

        async function testToggleCategory() {
            const categoryId = document.getElementById('toggle-category-id').value;
            const status = document.getElementById('toggle-status').value === 'true';
            
            if (!categoryId) {
                alert('Please enter a category ID');
                return;
            }
            
            const testData = {
                is_active: status
            };
            await makeAPIRequest('PATCH', `/admin/categories/${categoryId}/toggle`, testData, 'Toggle Category Status');
        }

        async function makeAPIRequest(method, endpoint, data, description) {
            const responseDiv = document.getElementById('api-response');
            
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                responseDiv.innerHTML = `<div class="loading">Testing ${description}...</div>`;
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    // If JSON parsing fails, get the response as text
                    const errorText = await response.text();
                    result = { error: errorText, status: response.status };
                }
                
                const statusClass = response.ok ? 'success' : 'error';
                responseDiv.innerHTML = `
                    <div class="${statusClass}">
                        <strong>${description} - Status: ${response.status}</strong>
                        <div class="response">${JSON.stringify(result, null, 2)}</div>
                    </div>
                `;
            } catch (error) {
                responseDiv.innerHTML = `
                    <div class="error">
                        <strong>${description} - Failed</strong>
                        <div class="response">${error.message}</div>
                    </div>
                `;
            }
        }

        // Modal functions
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            // Clear the form when closing
            document.getElementById('edit-category-form').reset();
            document.getElementById('edit-category-original-id').value = '';
        }

        function openAddCategoryModal() {
            // Clear the form for adding new category
            document.getElementById('edit-category-form').reset();
            document.getElementById('edit-category-original-id').value = '';
            document.querySelector('#editModal .modal-header h2').textContent = '‚ûï Add New Category';
            document.querySelector('#editModal .modal-actions button[type="submit"]').textContent = '‚ûï Add Category';
            
            // Show the modal
            document.getElementById('editModal').classList.add('active');
        }

        // Click outside modal to close
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Edit and delete functions
        async function editCategory(categoryId) {
            try {
                // Fetch the category data
                const response = await fetch(`${API_BASE}/categories/${categoryId}`);
                
                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    const errorText = await response.text();
                    alert(`Error: ${errorText || 'Invalid response from server'}`);
                    return;
                }
                
                if (data.success && data.category) {
                    const category = data.category;
                    
                    // Populate the modal form with category data
                    document.getElementById('edit-category-original-id').value = category.id;
                    document.getElementById('edit-category-id').value = category.id || '';
                    document.getElementById('edit-category-name').value = category.name || '';
                    document.getElementById('edit-category-icon').value = category.icon || '';
                    document.getElementById('edit-category-description').value = category.description || '';
                    document.getElementById('edit-category-group').value = category.group || 'home';
                    document.getElementById('edit-category-rate-type').value = category.rate_type || 'hourly';
                    document.getElementById('edit-category-base-rate').value = category.base_rate || '';
                    
                    // Set the toggle switch state
                    const isActive = category.is_active !== false;
                    const toggleSwitch = document.getElementById('edit-category-toggle');
                    const toggleCheckbox = document.getElementById('edit-category-is-active');
                    const statusBadge = document.getElementById('edit-status-badge');
                    
                    toggleCheckbox.checked = isActive;
                    if (isActive) {
                        toggleSwitch.classList.add('active');
                        statusBadge.textContent = 'Active';
                        statusBadge.classList.remove('inactive');
                        statusBadge.classList.add('active');
                    } else {
                        toggleSwitch.classList.remove('active');
                        statusBadge.textContent = 'Inactive';
                        statusBadge.classList.remove('active');
                        statusBadge.classList.add('inactive');
                    }
                    
                    // Show the modal
                    document.getElementById('editModal').classList.add('active');
                } else {
                    alert('Error loading category: ' + (data.message || 'Category not found'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }

        // Handle edit form submission (handles both add and update)
        document.getElementById('edit-category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const originalId = document.getElementById('edit-category-original-id').value;
            const categoryData = {
                id: document.getElementById('edit-category-id').value,
                name: document.getElementById('edit-category-name').value,
                icon: document.getElementById('edit-category-icon').value,
                description: document.getElementById('edit-category-description').value,
                group: document.getElementById('edit-category-group').value,
                rate_type: document.getElementById('edit-category-rate-type').value,
                base_rate: parseFloat(document.getElementById('edit-category-base-rate').value) || 0,
                is_active: document.getElementById('edit-category-is-active').checked,
                keywords: [],
                skills: [],
                documentation: [],
                options: {},
                pricing: {},
                sub_categories: [],
                time_modifiers: [],
                filters: [],
                subscription_pricing: {
                    monthly_pass: { enabled: false, price_cents: 0, price_display: "", description: "", stripe_price_id: "" },
                    flexible: { enabled: false, price_cents: 0, price_display: "", description: "", stripe_price_id: "" }
                },
                is_menu_based: false,
                menu_fields: {}
            };
            
            try {
                let response, result, successMessage;
                
                if (originalId) {
                    // Update existing category
                    response = await fetch(`${API_BASE}/admin/categories/${originalId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(categoryData)
                    });
                    successMessage = 'Category updated successfully!';
                } else {
                    // Create new category
                    response = await fetch(`${API_BASE}/admin/categories`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(categoryData)
                    });
                    successMessage = 'Category created successfully!';
                }
                
                let apiResult;
                try {
                    apiResult = await response.json();
                } catch (jsonError) {
                    const errorText = await response.text();
                    alert(`Error: ${errorText || 'Invalid response from server'}`);
                    return;
                }

                if (apiResult.success) {
                    closeEditModal();
                    loadCategories(); // Refresh the categories list
                    alert(successMessage);
                } else {
                    alert('Error: ' + (result.message || 'Failed to save category'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        });

        async function deleteCategory(categoryId) {
            if (!confirm(`Are you sure you want to delete category "${categoryId}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/categories/${categoryId}`, {
                    method: 'DELETE'
                });
                
                let deleteResult;
                try {
                    deleteResult = await response.json();
                } catch (jsonError) {
                    const errorText = await response.text();
                    alert(`Error: ${errorText || 'Invalid response from server'}`);
                    return;
                }
                
                if (deleteResult.success) {
                    alert('Category deleted successfully!');
                    loadCategories();
                } else {
                    alert('Error: ' + (deleteResult.message || 'Failed to delete category'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }

        // Toggle category status function
        async function toggleCategoryStatus(categoryId, newStatus) {
            try {
                const response = await fetch(`${API_BASE}/admin/categories/${categoryId}/toggle`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        is_active: newStatus
                    })
                });
                
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    const errorText = await response.text();
                    alert(`Error: ${errorText || 'Invalid response from server'}`);
                    return;
                }
                
                if (result.success) {
                    const statusText = newStatus ? 'enabled' : 'disabled';
                    alert(`Category ${statusText} successfully!`);
                    loadCategories(); // Refresh the categories list
                } else {
                    alert('Error: ' + (result.message || 'Failed to toggle category status'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }

        // Toggle switch event listener
        document.getElementById('edit-category-is-active').addEventListener('change', function() {
            const toggleSwitch = document.getElementById('edit-category-toggle');
            const statusBadge = document.getElementById('edit-status-badge');
            
            if (this.checked) {
                toggleSwitch.classList.add('active');
                statusBadge.textContent = 'Active';
                statusBadge.classList.remove('inactive');
                statusBadge.classList.add('active');
            } else {
                toggleSwitch.classList.remove('active');
                statusBadge.textContent = 'Inactive';
                statusBadge.classList.remove('active');
                statusBadge.classList.add('inactive');
            }
        });

        // Load categories on page load
        window.addEventListener('load', () => {
            loadCategories();
        });
    </script>
</body>
</html>
